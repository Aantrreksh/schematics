---

copyright:
  years: 2017, 2024
lastupdated: "2024-01-09"

keywords: schematics agent planning, planning agent, agent planning, command-line, api, ui

subcollection: schematics

---

{{site.data.keyword.attribute-definition-list}}


# Preparing for agent deployment
{: #plan-agent-overview}

Agents for {{site.data.keyword.bplong}} extend {{site.data.keyword.bpshort}}'s ability to work directly with your cloud infrastructure on your private network or any isolated network zones. Agents put users in control of the network configuration and access that they give to an agent to run workspace and action jobs. Agents are designed not to require inbound access from {{site.data.keyword.bpshort}} and the opening of inbound firewall or network access ports. All communication between the agent and {{site.data.keyword.bpshort}} is outbound from the agent and under user control.

{{site.data.keyword.bpshort}} Agents are a collection of microservices that runs on the Kubernetes clusters in your account. Also they use an {{site.data.keyword.objectstorageshort}} bucket as an intermediate or temporary data store for the log files and state-files generated by workspace or action jobs. 
{: shortdesc}

Review and complete the listed tasks to prepare your {{site.data.keyword.cloud}} environment to deploy a new agent.

- **Account and networks:** An agent provides {{site.data.keyword.bpshort}} the ability to run workspace and action jobs within a target account and the accounts private network. Network policies must be configured to allow the cluster that the agent is deployed on to communicate back to Schematics, also to the {{site.data.keyword.cloud_notm}} APIs, services and, for instance,  to a user private Git or Vault instances. For more information, see the section on [Planning agent network access and configuration](/docs/schematics?topic=schematics-plan-agent-overview#agentb1-network-config).
   - Record information about the allowed network zones and access.
- **Kubernetes cluster:** A {{site.data.keyword.bpshort}} agent can be deployed on existing private or public [{{site.data.keyword.containerlong_notm}}](/docs/containers?topic=containers-clusters) clusters. You can use an existing cluster or provision a new cluster with the following minimum configuration.
   - Minimum configuration: Three worker nodes with `b4x16` flavor. This configuration can be used to run four workspace or action jobs in parallel.
   - Record information about the cluster such as `cluster ID`, `cluster resource group`, and `region` for the later use.
- **{{site.data.keyword.cos}}:** The {{site.data.keyword.bpshort}} agent uses a {{site.data.keyword.objectstorageshort}} bucket to store temporary data. The {{site.data.keyword.cos_full_notm}} instance must be in the same resource group as the cluster. Also the new bucket must be in the same region as the cluster. 
    - To deploy an agent, you must have the necessary privileges to create the `HMAC credentials` for the {{site.data.keyword.objectstorageshort}} bucket and store the credential as a Kubernetes secret.
    - The {{site.data.keyword.cos_full_notm}} instance and bucket must be created for the successful deploy. 
    - Record information about the {{site.data.keyword.cos_full_notm}} resources such as `COS instance name`, `COS bucket name`, and `bucket region` for the later use.
- **IAM access permission:** At a minimum you must have access permissions for the Kubernetes service, Resource Group, {{site.data.keyword.objectstorageshort}}, and the {{site.data.keyword.bpshort}} service to [deploy an agent](/docs/schematics?topic=schematics-deploy-agent-overview&interface=cli).
    - When deploying an agent in another account, or when using a `ServiceID` or `APIKey`, you must see that the account administrator gives permission for all the services enlisted in [permission to deploy an agent](/docs/schematics?topic=schematics-access#agent-permissions).
- **{{site.data.keyword.cloud_notm}} CLI:** Use the recent version of {{site.data.keyword.cloud_notm}} CLI and the [{{site.data.keyword.bpshort}} CLI v1.12.12](/docs/schematics?topic=schematics-setup-cli#install-schematics-plugin) or higher plug-in to install an agent. For more information about plug-in installation, see [installing {{site.data.keyword.bpshort}} CLI plug-in](/docs/schematics?topic=schematics-setup-cli#install-schematics-plugin).

You can deploy only one agent instance on a Kubernetes cluster. To deploy multiple agents in a single {{site.data.keyword.cloud_notm}} account, they must be deployed to different Kubernetes clusters. Each agent and cluster can cater to different network isolation zones in your Cloud environment.
{: note}

An agent can be associated with and run jobs for one {{site.data.keyword.cloud_notm}} account and geographic region. Agents cannot be shared with other accounts or run jobs for multiple accounts. The diagram represents the association of agents with a {{site.data.keyword.bpshort}} geographic region. Here multiple agents with access to local private resources in remote locations are associated with different {{site.data.keyword.bpshort}} geographic instances.

![Agent association with {{site.data.keyword.bpshort}} instances](images/new/sc-agents-world.svg){: caption="Agent association with {{site.data.keyword.bpshort}} instances" caption-side="bottom"}

This image is an artistic representation and does not reflect actual political or geographic boundaries. {: note}

## Planning agent network access and configuration
{: #agentb1-network-config}

{{site.data.keyword.bpshort}} agents enable workspace and action jobs to be ran on your private network with direct access to work with resources on your private network and data centers. The following diagram illustrates a possible agent deployment model on a cluster environment with multiple VPCs connected through a transit gateway.

![{{site.data.keyword.bpshort}} agents connectivity](images/new/sc-agents-network.svg){: caption="{{site.data.keyword.bpshort}} Agents connectivity" caption-side="bottom"}

To work with private resources, your private cloud environment must be configured to allow the cluster to run on your agent. And has access to the APIs, services and resources to enable workspace and actions jobs to run. Typically Terraform uses HTTPS to configure service over port 443. Whereas Ansible uses SSH through port 22 to perform post-provisioning VSI configuration. These HTTPS and SSH network paths are illustrated in the diagram.

VPC Security Group or Access Control List policies must be configured to allow the agent cluster to access {{site.data.keyword.cloud_notm}} APIs by using HTTPS and any target VSIs by using SSH.

Access to data center resources can be configured by using [Direct Link](/docs/dl?topic=dl-dl-about) or a VPN connection.

With agents, you need to do the network security policies for the Kubernetes cluster, and any VPC Security Group or Access Control List policies for the running agent. Therefore, determining the ability of workspace and action jobs to access private cloud resources and the {{site.data.keyword.cloud_notm}} APIs for the service provisioning and configuration.

## Agent capacity planning 
{: #agent-capacity-planning}

You are advised to monitor the resource usage for the {{site.data.keyword.bpshort}} Agent pods to scale the worker nodes in the Kubernetes cluster based on the number of concurrent jobs that are run. To make the following changes, you can use the **Kubernetes dashboard** or [kubectl](/docs/containers?topic=containers-cli-install) commands.
- The number of concurrent Terraform, and Ansible jobs.
- The number of Terraform and Ansible pods.
- The resource limits for the agent deployment.

## Next steps
{: #agent-plan-nextsteps}

The next step is to [deploy an agent](/docs/schematics?topic=schematics-deploy-agent-overview).
